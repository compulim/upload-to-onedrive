<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Get OneDrive token</title>
    <style type="text/css">
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      button,
      input[type='text'] {
        font-family: inherit;
      }

      input[type='text'],
      input[type='url'] {
        font-size: inherit;
      }
    </style>
  </head>
  <body>
    <main></main>
  </body>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react",
        "react-dom": "https://esm.sh/react-dom",
        "react-dom/*": "https://esm.sh/react-dom/",
        "use-ref-from": "https://esm.sh/use-ref-from/",
        "use-state-with-ref": "https://esm.sh/use-state-with-ref"
      }
    }
  </script>
  <script src="https://esm.sh/tsx" type="module"></script>
  <script type="text/babel">
    import { useCallback, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { useRefFrom } from 'use-ref-from';
    import { useStateWithRef } from 'use-state-with-ref';

    function Scope({ checked, onChange, scope }) {
      const onChangeRef = useRefFrom(onChange);

      const handleChange = useCallback(
        event => onChangeRef.current?.(scope, event.currentTarget.checked),
        [onChangeRef]
      );

      return (
        <label>
          <input checked={checked} onChange={handleChange} type="checkbox" />
          &nbsp;{scope}
        </label>
      );
    }

    function App() {
      const [clientId, setClientId, clientIdRef] = useStateWithRef(() => sessionStorage?.getItem('CLIENT_ID') || '');
      const [redirectURI, setRedirectURI, redirectURIRef] = useStateWithRef(new URL('./redirect.html', location).href);
      const [scopeMap, setScopeMap, scopeMapRef] = useStateWithRef(
        Object.freeze(
          new Map([
            ['offline_access', true],
            ['onedrive.readonly', false],
            ['onedrive.readwrite', false],
            ['onedrive.appfolder', true]
          ])
        )
      );

      const authorizeURL = useMemo(() => {
        const scope = Array.from(scopeMap.entries())
          .filter(([_, checked]) => checked)
          .map(([scope]) => scope)
          .join(',');

        const url = new URL('https://login.live.com/oauth20_authorize.srf');

        url.searchParams.set('client_id', clientId);
        url.searchParams.set('scope', scope);
        url.searchParams.set('response_type', 'code');
        url.searchParams.set('redirect_uri', redirectURI);

        return url;
      }, [clientId, scopeMap, redirectURI]);

      const handleClientIDInput = useCallback(event => setClientId(event.currentTarget.value), [setClientId]);
      const handleRedirectURIInput = useCallback(event => setRedirectURI(event.currentTarget.value), [setRedirectURI]);

      const handleScopeChange = useCallback(
        (scope, checked) => {
          setScopeMap(scopeMap => {
            const nextScopeMap = new Map(scopeMap);

            nextScopeMap.set(scope, checked);

            return Object.freeze(nextScopeMap);
          });
        },
        [setScopeMap]
      );

      const handleSubmit = useCallback(event => event.preventDefault(), []);

      useEffect(() => {
        clientId ? sessionStorage?.setItem('CLIENT_ID', clientId) : sessionStorage?.removeItem('CLIENT_ID');
      }, [clientId]);

      return (
        <form onSubmit={handleSubmit}>
          <p>
            <label>
              <div>Client ID</div>
              <input onInput={handleClientIDInput} type="text" value={clientId} />
            </label>
          </p>
          <p>
            <div>Scopes</div>
            {Array.from(scopeMap.entries()).map(([scope, checked]) => (
              <div>
                <Scope checked={checked} onChange={handleScopeChange} scope={scope} />
              </div>
            ))}
          </p>
          <p>
            <label>
              <div>Redirect URI</div>
              <input onInput={handleRedirectURIInput} type="url" value={redirectURI} />
            </label>
          </p>
          <a href={authorizeURL.href} rel="noopener noreferer" target="_blank">Authorize</a>
        </form>
      );
    }

    const mainElement = document.querySelector('main');

    mainElement && createRoot(mainElement).render(<App />);
  </script>
</html>
