<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Display access token</title>
    <style type="text/css">
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      button,
      input[type='text'] {
        font-family: inherit;
      }

      input[type='text'],
      input[type='url'] {
        font-size: inherit;
      }

      .redeem-script {
        height: 200px;
        width: 600px;
      }
    </style>
  </head>
  <body>
    <main></main>
  </body>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react",
        "react-dom": "https://esm.sh/react-dom",
        "react-dom/*": "https://esm.sh/react-dom/",
        "use-ref-from": "https://esm.sh/use-ref-from/",
        "use-state-with-ref": "https://esm.sh/use-state-with-ref"
      }
    }
  </script>
  <script src="https://esm.sh/tsx" type="module"></script>
  <script type="text/babel">
    import { useCallback, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { useRefFrom } from 'use-ref-from';
    import { useStateWithRef } from 'use-state-with-ref';

    function App() {
      const [accessTokenJSON, setAccessTokenJSON, accessTokenJSONRef] = useStateWithRef('');
      const [clientId, setClientId, clientIdRef] = useStateWithRef(() => sessionStorage?.getItem('CLIENT_ID') || '');
      const [clientSecret, setClientSecret, clientSecretRef] = useStateWithRef('');

      const code = useMemo(() => {
        const searchParams = new URLSearchParams(location.search);

        return searchParams.get('code');
      }, []);

      const refreshTokenRef = useRefFrom(code);

      const handleClientIdInput = useCallback(event => setClientId(event.currentTarget.value), [setClientId]);
      const handleClientSecretInput = useCallback(
        event => setClientSecret(event.currentTarget.value),
        [setClientSecret]
      );

      const handleCopyAccessTokenButtonClick = useCallback(
        () => navigator.clipboard?.writeText(accessTokenJSONRef.current?.access_token),
        [accessTokenJSONRef]
      );

      const redeemScript = useMemo(() => {
        const redirectURI = new URL(location.href);

        redirectURI.search = '';

        const body = new Map();

        body.set('client_id', clientId || 'XXXXXXXXXX');
        body.set('client_secret', clientSecret || 'XXXXXXXXXX');
        body.set('code', code);
        body.set('grant_type', 'authorization_code');
        body.set('redirect_uri', redirectURI.href);

        const lines = ['curl'];

        lines.push(`  ${new URL('https://login.live.com/oauth20_token.srf')}`);
        lines.push('  -X POST');
        lines.push("  -H 'Content-Type: application/x-www-form-urlencoded'");

        for (const [name, value] of body) {
          // Escape ! so it don't trigger "history expansion" in shell script.
          lines.push(`  -d "${encodeURIComponent(name)}=${encodeURIComponent(value).replace(/!/gu, '\\!')}"`);
        }

        lines.push('  | jq');

        return lines.join(' \\\n');
      }, [clientId, clientSecret, setAccessTokenJSON]);

      useEffect(() => {
        clientId ? sessionStorage?.setItem('CLIENT_ID', clientId) : sessionStorage?.removeItem('CLIENT_ID');
      }, [clientId]);

      return (
        <div>
          <p>
            <label>
              <div>Code</div>
              <input autocomplete={false} readonly={true} spellCheck={false} type="text" value={code} />
            </label>
          </p>
          <p>
            <label>
              <div>Client ID</div>
              <input
                autocomplete={false}
                onInput={handleClientIdInput}
                spellCheck={false}
                type="text"
                value={clientId}
              />
            </label>
          </p>
          <p>
            <label>
              <div>Client Secret</div>
              <input
                autocomplete={false}
                onInput={handleClientSecretInput}
                spellCheck={false}
                type="password"
                value={clientSecret}
              />
            </label>
          </p>
          <p>
            <label>
              <div>Run cURL</div>
              <textarea
                autocomplete={false}
                className="redeem-script"
                readonly={true}
                spellCheck={false}
                value={redeemScript}
              />
            </label>
          </p>
          <p>
            To remove an application consent, go to{' '}
            <a href="https://microsoft.com/consent" rel="noopener noreferer" target="_blank">
              https://microsoft.com/consent
            </a>
            .
          </p>
        </div>
      );
    }

    const mainElement = document.querySelector('main');

    mainElement && createRoot(mainElement).render(<App />);
  </script>
</html>
