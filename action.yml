name: Upload to OneDrive
description: Upload a file to OneDrive

inputs:
  api-endpoint:
    default: https://api.onedrive.com/v1.0

  client-id:
    required: true

  client-secret:
    required: true

  filename:
    required: true

  onedrive-path:
    required: true

  path:
    required: true

  refresh-token:
    required: true

runs:
  using: composite
  steps:
    - id: get-access-token
      name: Get access token
      run: |
        set +H

        ACCESS_TOKEN=$(curl \
          --data "client_id=${{ inputs.client-id }}" \
          --data "client_secret=${{ inputs.client-secret }}" \
          --data "refresh_token=${{ inputs.refresh-token }}" \
          --data "grant_type=refresh_token" \
          --fail-with-body \
          "https://login.microsoftonline.com/consumers/oauth2/v2.0/token" | jq -r '.access_token')

        echo "access-token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
      shell: bash

    - name: Install tools
      run: sudo apt install jq
      shell: bash

    - name: Upload
      run: |
        set +H

        ACCESS_TOKEN=${{ steps.get-access-token.outputs.access-token }}
        API_ENDPOINT=${{ inputs.api-endpoint }}

        FILE_PATH=${{ inputs.path }}

        FILENAME="${FILE_PATH##*/}"

        LIST_APPROOT_RESPONSE=$(curl \
          --fail-with-body \
          --header "Authorization: Bearer $ACCESS_TOKEN" \
          $API_ENDPOINT/drive/special/approot)

        APPROOT_ID=$(echo $LIST_APPROOT_RESPONSE | jq -r .id)

        echo Item ID for application root is $APPROOT_ID.

        CREATE_UPLOAD_SESSION_JSON=$(jq -n --arg filename "$FILENAME" '{item:{name: $filename}}')

        echo Upload session URL dump
        echo $CREATE_UPLOAD_SESSION_JSON | jq

        CREATE_UPLOAD_SESSION_RESPONSE=$(curl \
          --fail-with-body \
          --header "Authorization: Bearer $ACCESS_TOKEN" \
          --json "$CREATE_UPLOAD_SESSION_JSON" \
          "$API_ENDPOINT/drive/items/$APPROOT_ID:/$FILENAME:/createUploadSession")

        echo $CREATE_UPLOAD_SESSION_RESPONSE

        UPLOAD_URL=$(echo $CREATE_UPLOAD_SESSION_RESPONSE | jq -r .uploadUrl)

        echo Upload URL is $UPLOAD_URL.

        curl \
          --fail-with-body \
          --upload-file "$FILE_PATH" \
          "$UPLOAD_URL"
      shell: bash
